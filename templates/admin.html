{% extends "base.html" %}

{% block title %}Panel de Administración - MotorSport{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-white fw-bold">Panel de Administración</h2>
        <div>
            <a href="{{ url_for('perfil') }}" class="btn btn-outline-light me-2">Volver al Perfil</a>
            <a href="{{ url_for('logout') }}" class="btn btn-danger">Cerrar Sesión</a>
        </div>
    </div>

    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold px-4" id="pills-noticias-tab" data-bs-toggle="pill"
                data-bs-target="#pills-noticias" type="button">
                <i class="bi bi-newspaper me-2"></i> Noticias
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold px-4" id="pills-vehiculos-tab" data-bs-toggle="pill"
                data-bs-target="#pills-vehiculos" type="button">
                <i class="bi bi-car-front-fill me-2"></i> Vehículos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold px-4" id="pills-usuarios-tab" data-bs-toggle="pill"
                data-bs-target="#pills-usuarios" type="button">
                <i class="bi bi-people-fill me-2"></i> Usuarios
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">

        <div class="tab-pane fade show active" id="pills-noticias">
            <div class="card bg-dark text-white border-secondary mb-4">
                <div class="card-header border-secondary text-success fw-bold">
                    <i class="bi bi-plus-circle"></i> Nueva Noticia
                </div>
                <div class="card-body">
                    <form action="{{ url_for('crear_noticia') }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Título</label>
                                <input type="text" name="titulo"
                                    class="form-control bg-black text-white border-secondary" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Categoría</label>
                                <select name="categoria_id" class="form-select bg-black text-white border-secondary"
                                    required>
                                    <option value="" selected disabled>Elige...</option>
                                    {% for cat in categorias %}
                                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Imagen URL</label>
                                <input type="text" name="imagen"
                                    class="form-control bg-black text-white border-secondary">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contenido</label>
                            <textarea name="contenido" rows="3"
                                class="form-control bg-black text-white border-secondary" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Publicar Noticia</button>
                    </form>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-dark table-hover border-secondary align-middle">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Título</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for noticia in noticias %}
                        <tr>
                            <td>{{ noticia.date.strftime('%Y-%m-%d') if noticia.date else '-' }}</td>
                            <td>{{ noticia.title }}</td>
                            <td class="text-end">
                                <a href="{{ url_for('editar_noticia', id=noticia.id) }}"
                                    class="btn btn-sm btn-warning me-1"><i class="bi bi-pencil"></i></a>
                                <a href="{{ url_for('borrar_noticia', id=noticia.id) }}" class="btn btn-sm btn-danger"
                                    onclick="return confirm('¿Borrar?');"><i class="bi bi-trash"></i></a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-vehiculos">
            <div class="card bg-dark text-white border-secondary mb-4">
                <div class="card-header border-secondary text-warning fw-bold">
                    <i class="bi bi-plus-circle"></i> Nuevo Vehículo
                </div>
                <div class="card-body">
                    <form action="{{ url_for('crear_vehiculo') }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Nombre Modelo</label>
                                <input type="text" name="nombre"
                                    class="form-control bg-black text-white border-secondary" required
                                    placeholder="Ej: SF-24">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Fabricante/Equipo</label>
                                <input type="text" name="fabricante"
                                    class="form-control bg-black text-white border-secondary" required
                                    placeholder="Ej: Ferrari">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Categoría</label>
                                <input type="text" name="categoria"
                                    class="form-control bg-black text-white border-secondary"
                                    placeholder="Ej: F1, Hypercar...">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Motor</label>
                                <input type="text" name="motor"
                                    class="form-control bg-black text-white border-secondary"
                                    placeholder="V6 Turbo Hybrid">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">CV</label>
                                <input type="number" name="cv" class="form-control bg-black text-white border-secondary"
                                    placeholder="1000">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Vel. Max</label>
                                <input type="number" name="velocidad"
                                    class="form-control bg-black text-white border-secondary" placeholder="350">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">0-100</label>
                                <input type="number" step="0.1" name="aceleracion"
                                    class="form-control bg-black text-white border-secondary" placeholder="2.4">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Imagen URL</label>
                                <input type="text" name="imagen"
                                    class="form-control bg-black text-white border-secondary">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-warning text-dark fw-bold w-100">Añadir al Garaje</button>
                    </form>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-dark table-hover border-secondary align-middle">
                    <thead>
                        <tr>
                            <th>Foto</th>
                            <th>Modelo</th>
                            <th>Equipo</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for coche in vehiculos %}
                        <tr>
                            <td style="width: 80px;">
                                {% if 'http' in (coche.image or '') %}
                                <img src="{{ coche.image }}" alt=""
                                    style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px;">
                                {% else %}
                                <img src="{{ url_for('static', filename=coche.image) }}" alt=""
                                    style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px;">
                                {% endif %}
                            </td>
                            <td>{{ coche.name }}</td>
                            <td>{{ coche.manufacturer }}</td>
                            <td class="text-end">
                                <a href="{{ url_for('borrar_vehiculo', id=coche.id) }}" class="btn btn-sm btn-danger"
                                    onclick="return confirm('¿Borrar este coche?');"><i class="bi bi-trash"></i></a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">El garaje está vacío. ¡Añade coches!</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-usuarios">
            <div class="card bg-dark text-white border-secondary mb-4">
                <div class="card-header border-secondary text-info fw-bold">
                    <i class="bi bi-people-fill"></i> Listado de Usuarios
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover border-secondary align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Usuario</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for usuario in users %}
                                <tr>
                                    <td>#{{ usuario.id }}</td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                                style="width: 30px; height: 30px;">
                                                {{ usuario.username[0] | upper }}
                                            </div>
                                            {{ usuario.username }}
                                        </div>
                                    </td>
                                    <td>{{ usuario.email }}</td>
                                    <td>
                                        {% if usuario.role == 'admin' %}
                                        <span class="badge bg-danger">ADMIN</span>
                                        {% else %}
                                        <span class="badge bg-secondary">USUARIO</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if usuario.id != current_user.id %}
                                        <form action="{{ url_for('eliminar_usuario', id=usuario.id) }}" method="POST"
                                            onsubmit="return confirm('¿Seguro que quieres eliminar a {{ usuario.username }}?');"
                                            style="display: inline;">

                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-trash"></i> Eliminar
                                            </button>
                                        </form>
                                        {% else %}
                                        <span class="text-muted small fst-italic">Cuenta actual</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No hay usuarios registrados.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}